# Архитектура системы

## 1. Общая картина

### 1.1 Что это за система

Система для массовой отправки email с высокой доставляемостью. Состоит из:

- **AMS Enterprise** (управляющий центр) — УЖЕ СУЩЕСТВУЕТ, не разрабатываем
  - ⚠️ **ВАЖНО:** AMS Enterprise — это **десктопное приложение для Windows**, а не веб-сервис
  - См. [AMS_INTEGRATION_ALTERNATIVES.md](AMS_INTEGRATION_ALTERNATIVES.md) для вариантов интеграции
- **Send Server** (сервер отправки) — РАЗРАБАТЫВАЕМ

### 1.2 Зачем нужен Send Server

AMS Enterprise хранит базу получателей, шаблоны, управляет кампаниями. Но отправка идёт через отдельные серверы, потому что:

1. **Изоляция репутации** — если IP попал в блеклист, меняем сервер
2. **Масштабирование** — можно добавлять серверы
3. **Распределение** — разные домены, разные IP
4. **Юридическая защита** — серверы в разных юрисдикциях

### 1.3 Схема взаимодействия

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AMS ENTERPRISE                                  │
│                         (не разрабатываем)                                   │
│                                                                             │
│  • База получателей                                                         │
│  • Шаблоны писем                                                            │
│  • Управление кампаниями                                                    │
│  • Аналитика                                                                │
│  • Выбор сервера отправки                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP POST (JSON)
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│ Send Server 1 │         │ Send Server 2 │         │ Send Server N │
│               │         │               │         │               │
│ domain1.com   │         │ domain2.com   │         │ domainN.com   │
│ IP: 1.2.3.4   │         │ IP: 5.6.7.8   │         │ IP: x.x.x.x   │
└───────────────┘         └───────────────┘         └───────────────┘
        │                           │                           │
        └───────────────────────────┼───────────────────────────┘
                                    │
                                    ▼
                            ┌───────────────┐
                            │   ИНТЕРНЕТ    │
                            │ Gmail, Yahoo  │
                            │ Outlook, etc  │
                            └───────────────┘
```

---

## 2. Архитектура Send Server

### 2.1 Компоненты (ОБЯЗАТЕЛЬНЫЕ)

```
┌────────────────────────────────────────────────────────────────────────────┐
│                           SEND SERVER                                       │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                         NGINX                                       │    │
│  │                    (reverse proxy)                                  │    │
│  │                                                                     │    │
│  │  • SSL termination (HTTPS)                                          │    │
│  │  • Маршрутизация запросов                                           │    │
│  │  • Rate limiting                                                    │    │
│  │  • Gzip compression                                                 │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                │                    │                    │                  │
│       /api/*   │          /track/*  │          /postal/* │                  │
│                ▼                    ▼                    ▼                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │    RAILS API     │  │ TRACKING SERVICE │  │   POSTAL WEB     │          │
│  │    порт 3000     │  │    порт 3001     │  │   порт 5000      │          │
│  │                  │  │                  │  │                  │          │
│  │ • Приём запросов │  │ • Открытия       │  │ • Мониторинг     │          │
│  │ • Сборка писем   │  │ • Клики          │  │ • Логи           │          │
│  │ • Трекинг        │  │ • Репорты в AMS  │  │                  │          │
│  └────────┬─────────┘  └────────┬─────────┘  └──────────────────┘          │
│           │                     │                                           │
│           ▼                     │                                           │
│  ┌──────────────────┐           │                                           │
│  │     SIDEKIQ      │           │                                           │
│  │ (background jobs)│           │                                           │
│  │                  │           │                                           │
│  │ • BuildEmailJob  │           │                                           │
│  │ • SendToPostalJob│           │                                           │
│  │ • ReportToAmsJob │           │                                           │
│  └────────┬─────────┘           │                                           │
│           │                     │                                           │
│           ▼                     ▼                                           │
│  ┌──────────────────────────────────────────────────────────────────┐      │
│  │                          REDIS                                    │      │
│  │                                                                   │      │
│  │  • Sidekiq очереди                                                │      │
│  │  • Кэш шаблонов                                                   │      │
│  │  • Rate limiting счётчики                                         │      │
│  └──────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
│           ┌────────────────────────┼────────────────────────┐               │
│           ▼                        ▼                        ▼               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │   POSTGRESQL     │  │    MARIADB       │  │    RABBITMQ      │          │
│  │ (данные Rails)   │  │ (данные Postal)  │  │ (очереди Postal) │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────┐      │
│  │                          POSTAL                                   │      │
│  │                                                                   │      │
│  │  • Web Server (API) — порт 5000                                   │      │
│  │  • Workers (обработка очереди)                                    │      │
│  │  • SMTP Server — порт 25                                          │      │
│  │  • DKIM подпись                                                   │      │
│  └──────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
                                     ▼
                                 ИНТЕРНЕТ
```

### 2.2 Почему именно такая архитектура

| Компонент | Зачем нужен | Альтернативы |
|-----------|-------------|--------------|
| **Rails API** | Сборка писем, трекинг-ссылки | Node.js, но Rails быстрее для такой задачи |
| **Sidekiq** | Асинхронная обработка | Resque, но Sidekiq производительнее |
| **Redis** | Быстрые очереди, кэш | Memcached, но Redis универсальнее |
| **Postal** | Отправка email, DKIM | Postfix напрямую, но Postal удобнее |
| **PostgreSQL** | Надёжное хранение логов | MySQL, но PostgreSQL лучше для JSON |
| **Nginx** | Reverse proxy, SSL | HAProxy, но Nginx проще |

### 2.3 Что НЕ входит в Send Server

- ❌ Управление списками получателей (это в AMS)
- ❌ Редактор шаблонов (это в AMS)
- ❌ Управление кампаниями (это в AMS)
- ❌ Расписание рассылок (это в AMS)
- ❌ Аналитика и отчёты (это в AMS)

Send Server ТОЛЬКО:
- ✅ Принимает данные
- ✅ Собирает письмо
- ✅ Отправляет
- ✅ Трекает события
- ✅ Сообщает статус

---

## 3. Поток данных (Data Flow)

### 3.1 Отправка письма

```
STEP 1: AMS → Send Server
══════════════════════════════════════════════════════════════════════════════

AMS Enterprise отправляет HTTP POST на /api/v1/send:

{
  "recipient": "user@gmail.com",
  "template_id": "promo_welcome",
  "from_name": "Kate Roleson",
  "from_email": "kate@domain.com",
  "subject": "Welcome Gift",
  "variables": {
    "name": "John",
    "promo_code": "SPIN50",
    "bonus_amount": "100"
  },
  "tracking": {
    "campaign_id": "camp_12345",
    "message_id": "msg_67890",
    "affiliate_id": "aff_abc123"
  },
  "options": {
    "priority": "normal",
    "tags": ["welcome", "promo"]
  }
}


STEP 2: Rails API обрабатывает
══════════════════════════════════════════════════════════════════════════════

1. Валидация API ключа (Authorization header)
2. Валидация JSON схемы
3. Создание записи в email_logs (status: "queued")
4. Создание Sidekiq job (BuildEmailJob)
5. Возврат ответа: { "status": "queued", "message_id": "..." }


STEP 3: Sidekiq обрабатывает (BuildEmailJob)
══════════════════════════════════════════════════════════════════════════════

1. Загрузка шаблона:
   - Сначала из Redis кэша
   - Если нет — из PostgreSQL
   - Если нет — запрос к AMS API

2. Рендеринг Liquid шаблона:
   - Подстановка переменных
   - {{ name }} → "John"
   - {{ promo_code }} → "SPIN50"

3. Инъекция трекинга:
   - Замена всех href на трекинг-ссылки
   - Добавление трекинг-пикселя перед </body>

4. Генерация заголовков:
   - Message-ID (уникальный)
   - Date
   - X-Campaign-ID
   - List-Unsubscribe

5. Отправка в Postal API


STEP 4: Postal отправляет
══════════════════════════════════════════════════════════════════════════════

1. Postal получает письмо через API
2. Добавляет в очередь (RabbitMQ)
3. Worker берёт из очереди
4. Подписывает DKIM
5. Отправляет через SMTP
6. Webhook обратно с результатом


STEP 5: Трекинг (когда получатель открывает/кликает)
══════════════════════════════════════════════════════════════════════════════

Открытие:
1. Email клиент загружает картинку: GET /track/o?eid=xxx&cid=yyy
2. Tracking Service логирует событие
3. Отправляет webhook в AMS
4. Возвращает 1x1 прозрачный PNG

Клик:
1. Получатель кликает ссылку: GET /track/c?url=xxx&eid=yyy&cid=zzz
2. Tracking Service логирует событие
3. Отправляет webhook в AMS
4. 302 редирект на оригинальный URL
```

### 3.2 Диаграмма последовательности

```
AMS          Rails API      Sidekiq       Postal        Gmail        User
 │               │             │            │             │            │
 │  POST /send   │             │            │             │            │
 │──────────────►│             │            │             │            │
 │               │             │            │             │            │
 │               │ Enqueue job │            │             │            │
 │               │────────────►│            │             │            │
 │               │             │            │             │            │
 │  {queued}     │             │            │             │            │
 │◄──────────────│             │            │             │            │
 │               │             │            │             │            │
 │               │             │ Build HTML │             │            │
 │               │             │────┐       │             │            │
 │               │             │    │       │             │            │
 │               │             │◄───┘       │             │            │
 │               │             │            │             │            │
 │               │             │ POST /send │             │            │
 │               │             │───────────►│             │            │
 │               │             │            │             │            │
 │               │             │            │ SMTP send   │            │
 │               │             │            │────────────►│            │
 │               │             │            │             │            │
 │               │             │            │  Delivered  │            │
 │               │             │            │◄────────────│            │
 │               │             │            │             │            │
 │               │  Webhook    │            │             │            │
 │               │◄────────────│────────────│             │            │
 │               │             │            │             │            │
 │  Callback     │             │            │             │ Open email │
 │◄──────────────│             │            │             │◄───────────│
 │               │             │            │             │            │
 │               │             │            │             │ GET /track │
 │               │◄────────────│────────────│─────────────│────────────│
 │               │             │            │             │            │
 │  Open event   │             │            │             │            │
 │◄──────────────│             │            │             │            │
```

---

## 4. Шаблонизация (Liquid)

### 4.1 Почему Liquid, а не ERB

| Критерий | ERB | Liquid |
|----------|-----|--------|
| Безопасность | ❌ Может выполнять Ruby код | ✅ Песочница |
| Пользовательские шаблоны | ❌ Опасно | ✅ Безопасно |
| Производительность | Быстрее | Немного медленнее |
| Синтаксис | Ruby | Простой |

**Выбор: Liquid** — потому что шаблоны могут редактироваться в AMS пользователями.

### 4.2 Переменные в шаблонах

**ОБЯЗАТЕЛЬНЫЕ переменные (всегда передаются):**

```liquid
{{ recipient_email }}      - Email получателя
{{ unsubscribe_url }}      - Ссылка отписки (генерируется автоматически)
{{ tracking_pixel }}       - Пиксель отслеживания (вставляется автоматически)
```

**ПОЛЬЗОВАТЕЛЬСКИЕ переменные (из AMS):**

```liquid
{{ name }}                 - Имя получателя
{{ promo_code }}           - Промокод
{{ bonus_amount }}         - Сумма бонуса
{{ custom_field_1 }}       - Любое кастомное поле
```

### 4.3 Пример шаблона

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{{ subject }}</title>
</head>
<body>
  <h1>Hello, {{ name | default: "Friend" }}!</h1>
  
  <p>Your exclusive promo code: <strong>{{ promo_code }}</strong></p>
  
  {% if bonus_amount %}
  <p>Get {{ bonus_amount }} bonus points!</p>
  {% endif %}
  
  <a href="{{ main_link }}">Claim Now</a>
  
  <footer>
    <a href="{{ unsubscribe_url }}">Unsubscribe</a>
  </footer>
  
  {{ tracking_pixel }}
</body>
</html>
```

### 4.4 Как работает трекинг-инъекция

**ДО обработки:**
```html
<a href="https://casino.com/signup">Click Here</a>
```

**ПОСЛЕ обработки:**
```html
<a href="https://track.domain.com/c?url=aHR0cHM6Ly9jYXNpbm8uY29tL3NpZ251cA==&eid=dXNlckBnbWFpbC5jb20=&cid=camp_12345&mid=msg_67890">Click Here</a>
```

**Компоненты трекинг-ссылки:**
- `url` — оригинальный URL в Base64
- `eid` — email получателя в Base64
- `cid` — ID кампании
- `mid` — ID сообщения

---

## 5. Требования к серверу

### 5.1 Минимальные (до 10,000 писем/день)

| Ресурс | Значение |
|--------|----------|
| CPU | 2 vCPU |
| RAM | 4 GB |
| Disk | 50 GB SSD |
| OS | Ubuntu 22.04 LTS |

### 5.2 Рекомендуемые (до 100,000 писем/день)

| Ресурс | Значение |
|--------|----------|
| CPU | 4 vCPU |
| RAM | 8 GB |
| Disk | 100 GB SSD |
| OS | Ubuntu 22.04 LTS |

### 5.3 Высоконагруженные (100,000+ писем/день)

| Ресурс | Значение |
|--------|----------|
| CPU | 8 vCPU |
| RAM | 16 GB |
| Disk | 200 GB SSD |
| OS | Ubuntu 22.04 LTS |
| Дополнительно | Отдельный сервер для PostgreSQL |

### 5.4 Сетевые требования

**Открытые порты:**
- `22` — SSH (изменить на нестандартный!)
- `80` — HTTP (для Let's Encrypt)
- `443` — HTTPS
- `25` — SMTP (outbound)
- `587` — SMTP Submission (опционально)

**DNS записи:**
- `A` — указывает на IP сервера
- `MX` — для приёма bounce (опционально)
- `TXT (SPF)` — `v=spf1 ip4:YOUR_IP -all`
- `TXT (DKIM)` — публичный ключ
- `TXT (DMARC)` — `v=DMARC1; p=reject; rua=mailto:dmarc@domain.com`
- `PTR` — reverse DNS (настраивается у хостера)

---

## 6. Отказоустойчивость

### 6.1 Что может сломаться

| Компонент | Последствия | Решение |
|-----------|-------------|---------|
| Rails API | Новые письма не принимаются | Перезапуск, масштабирование |
| Sidekiq | Очередь растёт | Перезапуск, добавить workers |
| Redis | Потеря очереди | Redis persistence, sentinel |
| PostgreSQL | Потеря логов | Репликация, бэкапы |
| Postal | Не отправляется | Перезапуск, проверка SMTP |
| Nginx | Сервер недоступен | Перезапуск |

### 6.2 Health checks

Rails API должен иметь endpoint:

```
GET /api/v1/health

Response 200:
{
  "status": "healthy",
  "components": {
    "database": "ok",
    "redis": "ok",
    "sidekiq": "ok",
    "postal": "ok"
  },
  "queues": {
    "default": 0,
    "mailers": 5,
    "critical": 0
  },
  "stats": {
    "sent_today": 12450,
    "limit_today": 50000,
    "available": 37550
  }
}

Response 503:
{
  "status": "unhealthy",
  "components": {
    "database": "ok",
    "redis": "error",
    "sidekiq": "ok",
    "postal": "ok"
  },
  "error": "Redis connection failed"
}
```

---

## 7. Масштабирование

### 7.1 Вертикальное

Просто увеличить ресурсы сервера (CPU, RAM).

### 7.2 Горизонтальное

Добавить больше Send Servers в пул AMS.

### 7.3 Внутри одного сервера

- Увеличить количество Sidekiq workers
- Увеличить Puma workers
- Увеличить Postal workers

---

## 8. Критические ошибки (избегать!)

### ❌ НЕ ДЕЛАТЬ:

1. **Не хранить пароли в коде** — только в environment variables
2. **Не логировать email адреса полностью** — маскировать: `u***@gmail.com`
3. **Не отправлять без DKIM** — письма попадут в спам
4. **Не игнорировать bounce** — портит репутацию
5. **Не превышать лимиты** — приводит к блокировке IP
6. **Не использовать ERB для пользовательских шаблонов** — уязвимость RCE

### ✅ ОБЯЗАТЕЛЬНО:

1. **Валидировать все входные данные**
2. **Использовать prepared statements** (защита от SQL injection)
3. **Ограничивать rate** на API
4. **Логировать все действия**
5. **Мониторить очереди**
6. **Настроить алерты**

---

## 9. Веб-интерфейс

### 9.1 Что есть

| Интерфейс | URL | Описание |
|-----------|-----|----------|
| Sidekiq Web UI | `/sidekiq/` | Управление очередями, просмотр jobs |
| Postal Web UI | `/postal/` | Мониторинг Postal, логи SMTP |
| Health API | `/api/v1/health` | JSON со статусом компонентов |
| Stats API | `/api/v1/stats` | JSON со статистикой |

### 9.2 Чего нет

- ❌ Собственный дашборд Send Server
- ❌ Визуальная статистика
- ❌ Просмотр логов в браузере
- ❌ Управление шаблонами через UI

### 9.3 Рекомендации

Для визуализации рекомендуется:
1. **Grafana** + Prometheus — графики и дашборды
2. **Kibana** + Elasticsearch — анализ логов
3. Или использовать интерфейс **AMS Enterprise**

---

## 10. Связанные документы

| Документ | Описание |
|----------|----------|
| [AMS_REQUIREMENTS.md](AMS_REQUIREMENTS.md) | ⚠️ Требования к AMS (уточнить перед разработкой!) |
| [AMS_INTEGRATION_ALTERNATIVES.md](AMS_INTEGRATION_ALTERNATIVES.md) | ⚠️ Альтернативные способы интеграции (SMTP vs HTTP) |
| [INTEGRATION.md](INTEGRATION.md) | Детали интеграции AMS ↔ Send Server |
| [DATA_FLOW.md](DATA_FLOW.md) | Все потоки данных в системе |
| [POSTAL_INTEGRATION.md](POSTAL_INTEGRATION.md) | Интеграция с Postal (SMTP сервер) |
| [API_SPECIFICATION.md](API_SPECIFICATION.md) | Спецификация REST API |
| [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md) | Схема базы данных |
| [SECURITY.md](SECURITY.md) | Требования безопасности |
| [DEPLOYMENT.md](DEPLOYMENT.md) | Инструкции по развёртыванию |
| [MISSING_COMPONENTS.md](MISSING_COMPONENTS.md) | Что нужно разработать |
| [AI_DEVELOPER_INSTRUCTIONS.md](AI_DEVELOPER_INSTRUCTIONS.md) | Инструкции для ИИ |

---

## 11. FAQ

### Q: Почему AMS не отправляет готовый HTML?

**A:** Чтобы Send Server мог:
1. Инжектить свои трекинг-ссылки (с доменом Send Server)
2. Кэшировать шаблоны локально
3. Работать автономно при недоступности AMS

### Q: Почему используется Liquid, а не ERB?

**A:** Безопасность. Liquid — это песочница, ERB может выполнять произвольный Ruby код. Шаблоны редактируются пользователями в AMS.

### Q: Зачем нужен отдельный Tracking Service?

**A:** Производительность. Трекинг-запросы (открытия, клики) могут быть очень частыми. Отдельный легковесный сервис (Sinatra) обрабатывает их быстрее, чем Rails.

### Q: Как масштабировать систему?

**A:** 
1. Вертикально: увеличить ресурсы сервера
2. Горизонтально: добавить больше Send Server'ов в пул AMS
3. Внутри сервера: увеличить Sidekiq workers

### Q: Что делать если шаблон не найден?

**A:** 
1. Send Server проверяет Redis кэш
2. Если нет — проверяет PostgreSQL
3. Если нет — запрашивает у AMS API (fallback)
4. Если AMS недоступен — возвращает ошибку 404
