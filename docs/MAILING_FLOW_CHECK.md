# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ —Ä–∞—Å—Å—ã–ª–∫–∏ –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏—Å—å–º–∞ –æ—Ç AMS –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.

## –°–∫—Ä–∏–ø—Ç—ã

### 1. `check_mailing_flow.sh` - –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
./scripts/check_mailing_flow.sh [test_email] [campaign_id]
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
./scripts/check_mailing_flow.sh test@example.com campaign_123
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:**
- ‚úÖ SMTP Relay –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- ‚úÖ API endpoint `/api/v1/smtp/receive` –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –ü–ª–∞–≥–∏–Ω—ã SMTP Relay –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- ‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—á–∏—â–∞—é—Ç—Å—è –æ—Ç AMS —Å–ª–µ–¥–æ–≤
- ‚úÖ List-Unsubscribe –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
- ‚úÖ PostalClient –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–µ–∫–∏–Ω–≥–∞
- ‚úÖ Webhook endpoint –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ DeliveryError —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –±–∞—É–Ω—Å–∞—Ö
- ‚úÖ Dashboard –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ª–æ–≥–∏
- ‚úÖ –¢—Ä–µ–∫–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç (EmailOpen/EmailClick)
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

### 2. `check_mailing_flow_detailed.sh` - –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π —á–µ—Ä–µ–∑ Rails runner.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
./scripts/check_mailing_flow_detailed.sh [test_email]
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
./scripts/check_mailing_flow_detailed.sh test@example.com
```

## –≠—Ç–∞–ø—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### –≠–¢–ê–ü 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∏—Å—å–º–∞ –æ—Ç AMS
- –ü—Ä–æ–≤–µ—Ä–∫–∞ SMTP Relay (–ø–æ—Ä—Ç 2587)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoint `/api/v1/smtp/receive`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è EmailLog

### –≠–¢–ê–ü 2: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞ `rebuild_headers.js`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—Å—Ç–∫–∏ AMS –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ Message-ID

### –≠–¢–ê–ü 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –æ—Ç–ø–∏—Å–∫–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ List-Unsubscribe –∑–∞–≥–æ–ª–æ–≤–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ unsubscribe URL —Å campaign_id
- –ü—Ä–æ–≤–µ—Ä–∫–∞ unsubscribe endpoint

### –≠–¢–ê–ü 4: –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Postal
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ `track_clicks` –∏ `track_opens`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ SendSmtpEmailJob
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Postal API

### –≠–¢–ê–ü 5: –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –æ—Ç Postal
- –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook endpoint `/api/v1/webhook`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π (MessageSent, MessageBounced, MessageDelivered)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è DeliveryError

### –≠–¢–ê–ü 6: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ –¥–∞—à–±–æ—Ä–¥–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ Dashboard::LogsController
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π EmailLog
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CampaignStats

### –≠–¢–ê–ü 7: –†–∞–±–æ—Ç–∞ —Ç—Ä–µ–∫–∏–Ω–≥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–µ–π EmailOpen –∏ EmailClick
- –ü—Ä–æ–≤–µ—Ä–∫–∞ tracking endpoints
- –ü—Ä–æ–≤–µ—Ä–∫–∞ Analytics —Å –Ω–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏

### –≠–¢–ê–ü 8: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ CheckMailingThresholdsJob
- –ü—Ä–æ–≤–µ—Ä–∫–∞ MailingRule.thresholds_exceeded?
- –ü—Ä–æ–≤–µ—Ä–∫–∞ AmsClient.stop_mailing
- –ü—Ä–æ–≤–µ—Ä–∫–∞ ErrorClassifier.stop_mailing_categories
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –±–∞—É–Ω—Å–∞—Ö

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–°–∫—Ä–∏–ø—Ç—ã –≤—ã–≤–æ–¥—è—Ç:
- ‚úÖ –ó–µ–ª–µ–Ω—ã–º - —É—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚ùå –ö—Ä–∞—Å–Ω—ã–º - –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- üìä –ò—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–ø—Ä–æ–π–¥–µ–Ω–æ/–ø—Ä–æ–≤–∞–ª–µ–Ω–æ)

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker –∏ Docker Compose
- –î–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º `api` –∏ `smtp-relay`
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ù–∞ Ubuntu —Å–µ—Ä–≤–µ—Ä–µ
cd /opt/email-sender

# –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
./scripts/check_mailing_flow.sh

# –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
./scripts/check_mailing_flow_detailed.sh test@example.com
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–≤–∞—é—Ç—Å—è:

1. **SMTP Relay –Ω–µ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç:**
   ```bash
   docker compose restart smtp-relay
   ```

2. **API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:**
   ```bash
   docker compose restart api
   docker compose logs api --tail=50
   ```

3. **Postal API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:**
   ```bash
   docker compose restart postal
   docker compose logs postal --tail=50
   ```

4. **–ú–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:**
   ```bash
   docker compose exec api rails db:migrate
   ```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

–î–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```bash
./scripts/test_email_send.sh test@example.com campaign_123
```
