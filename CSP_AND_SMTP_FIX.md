# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è CSP –∏ SMTP Relay

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–≠—Ç–æ—Ç –∫–æ–º–º–∏—Ç —Ä–µ—à–∞–µ—Ç –¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û—à–∏–±–∫–∏ Content Security Policy (CSP)** - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –≤ Dashboard
2. **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** - –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: Content Security Policy

### –ü—Ä–æ–±–ª–µ–º–∞
Dashboard –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –≤–Ω–µ—à–Ω–∏–µ CDN –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ JavaScript –±–∏–±–ª–∏–æ—Ç–µ–∫, –Ω–æ CSP –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∏—Ö:

```
Loading the script 'https://cdn.tailwindcss.com/' violates CSP
Loading the script 'https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js' violates CSP
Loading the script 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js' violates CSP
```

### –†–µ—à–µ–Ω–∏–µ
–û–±–Ω–æ–≤–ª–µ–Ω `config/nginx.conf` –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —ç—Ç–∏—Ö –¥–æ–º–µ–Ω–æ–≤:

```nginx
# –ë—ã–ª–æ:
script-src 'self' 'unsafe-inline' 'unsafe-eval'

# –°—Ç–∞–ª–æ:
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net
style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com
font-src 'self' data: https://cdn.jsdelivr.net
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚úÖ –¢–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ CDN –¥–æ–º–µ–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
‚úÖ HTTPS —Ç–æ–ª—å–∫–æ (–∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞)
‚úÖ 'unsafe-inline' –∏ 'unsafe-eval' –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã Tailwind –∏ Alpine.js (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞)

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: SMTP Relay ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –≤ –∫–æ–º–º–∏—Ç–µ `756d3d2` –º—ã –ø–µ—Ä–µ—à–ª–∏ –æ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —á–µ—Ä–µ–∑ Dashboard:

- **–ë—ã–ª–æ:** `SMTP_RELAY_USERNAME` –∏ `SMTP_RELAY_PASSWORD` –≤ ENV + –ë–î
- **–°—Ç–∞–ª–æ:** –ú–æ–¥–µ–ª—å `SmtpCredential` —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ Dashboard UI

–ù–æ `docker-compose.yml` –≤—Å–µ –µ—â–µ —Å—Å—ã–ª–∞–ª—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:

```
WARN[0000] The "SMTP_RELAY_USERNAME" variable is not set. Defaulting to a blank string.
WARN[0000] The "SMTP_RELAY_PASSWORD" variable is not set. Defaulting to a blank string.
```

### –†–µ—à–µ–Ω–∏–µ

1. **–£–¥–∞–ª–µ–Ω—ã –∏–∑ docker-compose.yml:**
   - `SMTP_RELAY_USERNAME` (–±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   - `SMTP_RELAY_PASSWORD` (–±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

2. **–û—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ:**
   - `SMTP_RELAY_SECRET` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è HMAC –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É SMTP Relay –∏ API

3. **–û–±–Ω–æ–≤–ª–µ–Ω env.example.txt** —Å –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---

## üìö –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ SMTP –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ë—ã–ª–æ (—Å—Ç–∞—Ä–æ–µ)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AMS        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄSMTP‚îÄ‚îÄ‚ñ∂‚îÇ SMTP Relay   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄAPI‚îÄ‚îÄ‚ñ∂‚îÇ  API        ‚îÇ
‚îÇ  Enterprise ‚îÇ  (global)‚îÇ  (global)    ‚îÇ (global) ‚îÇ  (global)   ‚îÇ
‚îÇ             ‚îÇ          ‚îÇ  username/   ‚îÇ          ‚îÇ  username/  ‚îÇ
‚îÇ             ‚îÇ          ‚îÇ  password     ‚îÇ          ‚îÇ  password   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°—Ç–∞–ª–æ (–Ω–æ–≤–æ–µ)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AMS        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄSMTP‚îÄ‚îÄ‚ñ∂‚îÇ SMTP Relay   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄAPI‚îÄ‚îÄ‚ñ∂‚îÇ  API        ‚îÇ
‚îÇ  Enterprise ‚îÇ  (per-    ‚îÇ  validates   ‚îÇ (HMAC)   ‚îÇ  validates  ‚îÇ
‚îÇ             ‚îÇ  user)    ‚îÇ  against DB  ‚îÇ          ‚îÇ  against DB ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ                          ‚îÇ
                              ‚îÇ SmtpCredential           ‚îÇ SmtpCredential
                              ‚îÇ (username/password)      ‚îÇ (username/password)
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Dashboard
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ö–∞–∂–¥–æ–µ AMS –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–º–µ–µ—Ç —Å–≤–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ credentials
‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ/—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Dashboard UI –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
‚úÖ **–ê—É–¥–∏—Ç:** –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è credentials –≤ –ë–î
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ AMS –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ credentials
‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª–µ–π –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è credential

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø–æ—Å–ª–µ git pull)

```bash
cd /opt/email-sender

# 1. –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π SMTP_RELAY_SECRET –≤ .env
# (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω)
if ! grep -q "SMTP_RELAY_SECRET" .env; then
  echo "SMTP_RELAY_SECRET=$(openssl rand -hex 32)" >> .env
fi

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
docker compose down
docker compose up -d

# 3. –ü–æ–¥–æ–∂–¥–∞—Ç—å —Å—Ç–∞—Ä—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sleep 15
docker compose logs --tail=20

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Dashboard —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ CSP –æ—à–∏–±–æ–∫
# –û—Ç–∫—Ä—ã—Ç—å: https://linenarrow.com/dashboard
```

### –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Dashboard:**
   - –û—Ç–∫—Ä—ã—Ç—å `https://linenarrow.com/dashboard`
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Tailwind, Alpine.js –∏ Chart.js –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ CSP
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å SMTP credentials –¥–ª—è AMS:**
   - –í–æ–π—Ç–∏ –≤ Dashboard
   - –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª "SMTP Credentials"
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é credential –¥–ª—è AMS Enterprise
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å username/password (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!)
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å AMS Enterprise —Å —ç—Ç–∏–º–∏ credentials

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: CSP –≤ Dashboard
```bash
# –û—Ç–∫—Ä—ã—Ç—å https://linenarrow.com/dashboard
# –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ CSP
# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω (Tailwind —Ä–∞–±–æ—Ç–∞–µ—Ç)
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å (Alpine.js —Ä–∞–±–æ—Ç–∞–µ—Ç)
# –ì—Ä–∞—Ñ–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è (Chart.js —Ä–∞–±–æ—Ç–∞–µ—Ç)
```

### –¢–µ—Å—Ç 2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
```bash
docker compose config | grep -i "SMTP_RELAY"
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ SMTP_RELAY_SECRET
# –ù–ï –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å SMTP_RELAY_USERNAME –∏–ª–∏ SMTP_RELAY_PASSWORD
```

### –¢–µ—Å—Ç 3: SMTP Relay —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
docker compose logs smtp-relay | grep "HMAC Secret"
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç (–Ω–µ "NOT SET")
```

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. —Ç–∞–∫–∂–µ:
- `DEEP_ANALYSIS_AND_FIX_PLAN.md` - –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- `DASHBOARD_ANALYSIS.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Dashboard
- `env.example.txt` - –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ .env —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- `services/api/app/models/smtp_credential.rb` - –º–æ–¥–µ–ª—å —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

- [ ] Dashboard –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ CSP
- [ ] Tailwind CSS —Å—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Alpine.js –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Chart.js –≥—Ä–∞—Ñ–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] `SMTP_RELAY_SECRET` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env
- [ ] SMTP Relay –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "HMAC Secret: SET" (–∞ –Ω–µ "NOT SET")
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å SMTP Credential –≤ Dashboard
- [ ] AMS Enterprise –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ SMTP Relay

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã

- `f146426` - Fix code issues for clean startup
- `756d3d2` - Fix Dashboard issues and clean up redundant code (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ SMTP)
- `a2c4b11` - Add comprehensive Dashboard settings and analysis

