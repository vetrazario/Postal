<div class="space-y-10">
  <div>
    <h1 class="text-3xl font-bold text-gray-900">Mailing Rules</h1>
    <p class="mt-2 text-sm text-gray-700">Configure automatic mailing stop thresholds and AMS integration</p>
  </div>

  <div class="mx-auto max-w-4xl">
    <%= form_with model: @rule, url: dashboard_mailing_rules_path, method: :patch, class: "space-y-6" do |form| %>
      
      <!-- AMS API Connection -->
      <div class="rounded-md bg-white shadow-sm ring-1 ring-gray-900/5">
        <div class="px-4 py-6 sm:p-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">AMS API Connection</h2>
          <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-6">
            <div>
              <%= form.label :ams_api_url, "AMS API URL", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.text_field :ams_api_url,
                    placeholder: "http://192.168.1.100:80/api/v1",
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Full URL to AMS Enterprise API endpoint (e.g., http://IP:PORT/api/v1)
              </p>
            </div>

            <div>
              <%= form.label :ams_api_key, "AMS API Key", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.password_field :ams_api_key,
                    placeholder: "Enter AMS API key",
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                API key from AMS Enterprise Settings â†’ API Settings
              </p>
            </div>

            <div>
              <button type="button" 
                      id="test-connection-btn"
                      class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                Test Connection
              </button>
              <span id="test-result" class="ml-4 text-sm"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bounce Patterns -->
      <div class="rounded-md bg-white shadow-sm ring-1 ring-gray-900/5">
        <div class="px-4 py-6 sm:p-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Bounce Patterns</h2>
          <p class="text-sm text-gray-600 mb-6">
            Manage error patterns for bounce classification. Download the config file,
            edit patterns locally, and upload back.
          </p>

          <div class="grid max-w-2xl grid-cols-1 gap-4">
            <!-- Download -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div>
                <h3 class="text-sm font-medium text-gray-900">Download Configuration</h3>
                <p class="text-sm text-gray-500">Get current bounce patterns YAML file</p>
              </div>
              <%= link_to download_bounce_patterns_dashboard_mailing_rules_path,
                          class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" do %>
                ðŸ“¥ Download
              <% end %>
            </div>

            <!-- Upload -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div>
                <h3 class="text-sm font-medium text-gray-900">Upload Configuration</h3>
                <p class="text-sm text-gray-500">Upload edited YAML file (backup created automatically)</p>
              </div>
              <button type="button"
                      onclick="document.getElementById('bounce-patterns-upload').click()"
                      class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                ðŸ“¤ Upload
              </button>
            </div>

            <!-- Reset -->
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div>
                <h3 class="text-sm font-medium text-gray-900">Reset to Defaults</h3>
                <p class="text-sm text-gray-500">Restore original bounce patterns (backup created)</p>
              </div>
              <%= button_to 'ðŸ”„ Reset',
                            reset_bounce_patterns_dashboard_mailing_rules_path,
                            method: :post,
                            data: { confirm: 'Reset to default bounce patterns? Current config will be backed up.' },
                            class: "rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500" %>
            </div>

            <!-- Info -->
            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
              <h4 class="text-sm font-medium text-blue-900 mb-2">ðŸ’¡ How to edit patterns:</h4>
              <ol class="text-sm text-blue-700 space-y-1 list-decimal list-inside">
                <li>Click "Download" to get current configuration</li>
                <li>Edit the YAML file with any text editor</li>
                <li>Add/remove patterns under each category</li>
                <li>Click "Upload" to apply changes</li>
                <li>Changes take effect immediately</li>
              </ol>
              <p class="mt-3 text-sm text-blue-600">
                <strong>Example:</strong> To add Gmail rate limit pattern, add <code>'Gmail rate limit: 450 4.2.1'</code>
                under <code>rate_limit â†’ patterns</code>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Thresholds -->
      <div class="rounded-md bg-white shadow-sm ring-1 ring-gray-900/5">
        <div class="px-4 py-6 sm:p-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Stop Thresholds</h2>
          <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-6">
            <div>
              <%= form.label :max_bounce_rate, "Max Bounce Rate (%)", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.number_field :max_bounce_rate,
                    min: 0,
                    max: 100,
                    step: 1,
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Stop mailing if bounce rate exceeds this percentage
              </p>
            </div>

            <div>
              <%= form.label :max_rate_limit_errors, "Max Rate Limit Errors", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.number_field :max_rate_limit_errors,
                    min: 0,
                    step: 1,
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Stop mailing if number of rate limit errors exceeds this count
              </p>
            </div>

            <div>
              <%= form.label :max_spam_blocks, "Max Spam Blocks", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.number_field :max_spam_blocks,
                    min: 0,
                    step: 1,
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Stop mailing if number of spam blocks exceeds this count
              </p>
            </div>

            <div>
              <%= form.label :check_window_minutes, "Check Window (minutes)", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.number_field :check_window_minutes,
                    min: 1,
                    step: 1,
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
              <p class="mt-2 text-sm text-gray-500">
                Time window for checking thresholds (errors within this period)
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="rounded-md bg-white shadow-sm ring-1 ring-gray-900/5">
        <div class="px-4 py-6 sm:p-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Actions</h2>
          <div class="grid max-w-2xl grid-cols-1 gap-x-6 gap-y-6">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-900">Enable Auto-Stop</label>
                <p class="text-sm text-gray-500">Automatically stop mailings when thresholds are exceeded</p>
              </div>
              <div class="ml-4">
                <%= form.check_box :auto_stop_mailing, class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600" %>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-900">Active</label>
                <p class="text-sm text-gray-500">Enable this rule</p>
              </div>
              <div class="ml-4">
                <%= form.check_box :active, class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600" %>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-900">Email Notifications</label>
                <p class="text-sm text-gray-500">Send email when mailing is stopped</p>
              </div>
              <div class="ml-4">
                <%= form.check_box :notify_email, class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600" %>
              </div>
            </div>

            <div>
              <%= form.label :notification_email, "Notification Email", class: "block text-sm font-medium text-gray-900" %>
              <div class="mt-2">
                <%= form.email_field :notification_email,
                    placeholder: "admin@example.com",
                    class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-x-6">
        <%= form.submit "Save Settings", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Hidden file input for bounce patterns upload -->
<%= form_with url: upload_bounce_patterns_dashboard_mailing_rules_path,
              multipart: true,
              id: 'bounce-patterns-form',
              class: 'hidden' do |f| %>
  <%= f.file_field :bounce_patterns_file,
                   id: 'bounce-patterns-upload',
                   accept: '.yml,.yaml',
                   onchange: 'this.form.submit()' %>
<% end %>

<script>
  document.getElementById('test-connection-btn').addEventListener('click', function() {
    const btn = this;
    const resultSpan = document.getElementById('test-result');
    const form = btn.closest('form');
    const formData = new FormData(form);
    
    btn.disabled = true;
    btn.textContent = 'Testing...';
    resultSpan.textContent = '';
    
    fetch('<%= test_ams_connection_dashboard_mailing_rules_path %>', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        mailing_rule: {
          ams_api_url: formData.get('mailing_rule[ams_api_url]'),
          ams_api_key: formData.get('mailing_rule[ams_api_key]')
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        resultSpan.textContent = 'âœ“ ' + (data.message || 'Connection successful');
        resultSpan.className = 'ml-4 text-sm text-green-600';
      } else {
        resultSpan.textContent = 'âœ— ' + (data.error || 'Connection failed');
        resultSpan.className = 'ml-4 text-sm text-red-600';
      }
    })
    .catch(error => {
      resultSpan.textContent = 'âœ— Error: ' + error.message;
      resultSpan.className = 'ml-4 text-sm text-red-600';
    })
    .finally(() => {
      btn.disabled = false;
      btn.textContent = 'Test Connection';
    });
  });
</script>

