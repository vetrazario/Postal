<h2 style="margin-bottom: 20px;">Логи писем</h2>

<div class="filters">
  <form method="get" action="<%= dashboard_logs_path %>">
    <div class="form-group">
      <label>Период</label>
      <select name="period">
        <option value="today" <%= 'selected' if @period == 'today' %>>Сегодня</option>
        <option value="yesterday" <%= 'selected' if @period == 'yesterday' %>>Вчера</option>
        <option value="week" <%= 'selected' if @period == 'week' %>>Неделя</option>
        <option value="month" <%= 'selected' if @period == 'month' %>>Месяц</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Статус</label>
      <select name="status">
        <option value="">Все</option>
        <option value="queued" <%= 'selected' if @status == 'queued' %>>В очереди</option>
        <option value="processing" <%= 'selected' if @status == 'processing' %>>Обрабатывается</option>
        <option value="sent" <%= 'selected' if @status == 'sent' %>>Отправлено</option>
        <option value="delivered" <%= 'selected' if @status == 'delivered' %>>Доставлено</option>
        <option value="bounced" <%= 'selected' if @status == 'bounced' %>>Отклонено</option>
        <option value="failed" <%= 'selected' if @status == 'failed' %>>Ошибка</option>
        <option value="complained" <%= 'selected' if @status == 'complained' %>>Жалоба</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Кампания</label>
      <select name="campaign_id">
        <option value="">Все</option>
        <% @campaigns.each do |campaign_id| %>
          <option value="<%= campaign_id %>" <%= 'selected' if @campaign_id == campaign_id %>>
            <%= campaign_id %>
          </option>
        <% end %>
      </select>
    </div>
    
    <button type="submit">Применить</button>
  </form>
</div>

<% if @logs.present? %>
  <table>
    <thead>
      <tr>
        <th>Время</th>
        <th>Message ID</th>
        <th>Получатель</th>
        <th>Статус</th>
        <th>Кампания</th>
        <th>Открыто</th>
        <th>Клики</th>
      </tr>
    </thead>
    <tbody>
      <% @logs.each do |email| %>
        <tr>
          <td><%= email.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
          <td><%= email.message_id %></td>
          <td><%= email.recipient_masked %></td>
          <td>
            <span class="status-badge status-<%= email.status %>">
              <%= email.status %>
            </span>
          </td>
          <td><%= email.campaign_id %></td>
          <td>
            <%= email.tracking_events.select { |e| e.event_type == 'open' }.count %>
          </td>
          <td>
            <%= email.tracking_events.select { |e| e.event_type == 'click' }.count %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  
  <% if @total_pages > 1 %>
    <div class="pagination">
      <% if @current_page > 1 %>
        <%= link_to '← Предыдущая', dashboard_logs_path(page: @current_page - 1, period: @period, status: @status, campaign_id: @campaign_id) %>
      <% end %>
      
      <% (1..@total_pages).each do |page| %>
        <% if page == @current_page %>
          <span class="current"><%= page %></span>
        <% elsif page == 1 || page == @total_pages || (page >= @current_page - 2 && page <= @current_page + 2) %>
          <%= link_to page, dashboard_logs_path(page: page, period: @period, status: @status, campaign_id: @campaign_id) %>
        <% elsif page == @current_page - 3 || page == @current_page + 3 %>
          <span>...</span>
        <% end %>
      <% end %>
      
      <% if @current_page < @total_pages %>
        <%= link_to 'Следующая →', dashboard_logs_path(page: @current_page + 1, period: @period, status: @status, campaign_id: @campaign_id) %>
      <% end %>
    </div>
  <% end %>
<% else %>
  <div class="empty-state">
    <h3>Нет данных</h3>
    <p>Письма не найдены по заданным фильтрам</p>
  </div>
<% end %>

