#!/usr/bin/env python3
"""
AI Tasks - Ð¿Ñ€Ð¾ÑÑ‚Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸ Ð´Ð»Ñ AI Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð².

Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð² JSON Ñ„Ð°Ð¹Ð»Ð°Ñ…, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð°Ð¼Ð¸,
Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼ Ð°Ð³ÐµÐ½Ñ‚Ð°Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ñ Ð¾Ð±Ñ‰Ð¸Ð¼ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼.

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:
    ai-tasks list [PROJECT]           - Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
    ai-tasks add PROJECT "TITLE"      - Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ
    ai-tasks start PROJECT ID         - Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ (in_progress)
    ai-tasks done PROJECT ID          - Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ
    ai-tasks fail PROJECT ID          - Ð¿Ð¾Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ðº failed
    ai-tasks block PROJECT ID --by X  - Ð·Ð°Ð´Ð°Ñ‡Ð° ID Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ X
    ai-tasks next PROJECT             - ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð°Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°
    ai-tasks clear PROJECT            - ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
    ai-tasks reset PROJECT ID         - ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð² pending

ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:
    ai-tasks add myproject "Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ API endpoint"
    ai-tasks add myproject "ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹" --blocked-by 1
    ai-tasks list myproject
    ai-tasks start myproject 1
    ai-tasks done myproject 1
    ai-tasks next myproject
"""

import json
import os
import sys
import fcntl
from datetime import datetime
from pathlib import Path

# Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡
TASKS_DIR = Path.home() / ".ai-tasks" / "projects"


def ensure_dir():
    """Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚."""
    TASKS_DIR.mkdir(parents=True, exist_ok=True)


def get_project_file(project: str) -> Path:
    """ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°."""
    return TASKS_DIR / f"{project}.json"


def load_tasks(project: str) -> dict:
    """Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ Ñ„Ð°Ð¹Ð»Ð°."""
    ensure_dir()
    filepath = get_project_file(project)

    if not filepath.exists():
        return {"tasks": [], "next_id": 1}

    with open(filepath, "r") as f:
        fcntl.flock(f.fileno(), fcntl.LOCK_SH)
        try:
            return json.load(f)
        finally:
            fcntl.flock(f.fileno(), fcntl.LOCK_UN)


def save_tasks(project: str, data: dict):
    """Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ Ñ„Ð°Ð¹Ð»Ð°."""
    ensure_dir()
    filepath = get_project_file(project)

    with open(filepath, "w") as f:
        fcntl.flock(f.fileno(), fcntl.LOCK_EX)
        try:
            json.dump(data, f, indent=2, ensure_ascii=False)
        finally:
            fcntl.flock(f.fileno(), fcntl.LOCK_UN)


def now() -> str:
    """Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð² ISO Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ."""
    return datetime.now().isoformat()


def cmd_list(project: str = None):
    """ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð°Ñ‡."""
    if project:
        projects = [project]
    else:
        ensure_dir()
        projects = [f.stem for f in TASKS_DIR.glob("*.json")]

    if not projects:
        print("ÐÐµÑ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð². Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ñƒ: ai-tasks add PROJECT \"TITLE\"")
        return

    for proj in sorted(projects):
        data = load_tasks(proj)
        tasks = data.get("tasks", [])

        if not tasks:
            print(f"\n[{proj}] ÐÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡")
            continue

        print(f"\n[{proj}]")
        print("-" * 50)

        # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ
        by_status = {"in_progress": [], "pending": [], "completed": [], "failed": []}
        for t in tasks:
            by_status.get(t["status"], by_status["pending"]).append(t)

        for status in ["in_progress", "pending", "completed", "failed"]:
            for t in by_status[status]:
                # Ð¡Ð¸Ð¼Ð²Ð¾Ð» ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
                symbols = {
                    "pending": "â—‹",
                    "in_progress": "â—",
                    "completed": "â—",
                    "failed": "âœ—"
                }
                sym = symbols.get(t["status"], "?")

                # Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
                blocked = ""
                if t.get("blocked_by"):
                    blocked = f" [blocked by: {','.join(map(str, t['blocked_by']))}]"

                # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ñ€Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð»Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð°
                is_blocked = False
                if t.get("blocked_by"):
                    completed_ids = {x["id"] for x in tasks if x["status"] == "completed"}
                    is_blocked = not all(b in completed_ids for b in t["blocked_by"])

                lock = " ðŸ”’" if is_blocked else ""

                print(f"  {sym} #{t['id']}: {t['title']}{blocked}{lock}")


def cmd_add(project: str, title: str, blocked_by: list = None):
    """Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð´Ð°Ñ‡Ñƒ."""
    data = load_tasks(project)

    task = {
        "id": data["next_id"],
        "title": title,
        "status": "pending",
        "blocked_by": blocked_by or [],
        "created_at": now(),
        "updated_at": now()
    }

    data["tasks"].append(task)
    data["next_id"] += 1

    save_tasks(project, data)
    print(f"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð·Ð°Ð´Ð°Ñ‡Ð° #{task['id']}: {title}")

    if blocked_by:
        print(f"  Ð—Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚: {', '.join(map(str, blocked_by))}")


def cmd_update_status(project: str, task_id: int, status: str):
    """ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°Ð´Ð°Ñ‡Ð¸."""
    data = load_tasks(project)

    for task in data["tasks"]:
        if task["id"] == task_id:
            old_status = task["status"]
            task["status"] = status
            task["updated_at"] = now()
            save_tasks(project, data)
            print(f"#{task_id}: {old_status} â†’ {status}")
            return

    print(f"Ð—Ð°Ð´Ð°Ñ‡Ð° #{task_id} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
    sys.exit(1)


def cmd_block(project: str, task_id: int, blocked_by: list):
    """Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ."""
    data = load_tasks(project)

    for task in data["tasks"]:
        if task["id"] == task_id:
            existing = set(task.get("blocked_by", []))
            existing.update(blocked_by)
            task["blocked_by"] = list(existing)
            task["updated_at"] = now()
            save_tasks(project, data)
            print(f"#{task_id} Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚: {', '.join(map(str, task['blocked_by']))}")
            return

    print(f"Ð—Ð°Ð´Ð°Ñ‡Ð° #{task_id} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°")
    sys.exit(1)


def cmd_next(project: str):
    """ÐÐ°Ð¹Ñ‚Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½ÑƒÑŽ Ð·Ð°Ð´Ð°Ñ‡Ñƒ."""
    data = load_tasks(project)
    tasks = data.get("tasks", [])

    if not tasks:
        print("ÐÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡")
        return

    completed_ids = {t["id"] for t in tasks if t["status"] == "completed"}

    for task in tasks:
        if task["status"] != "pending":
            continue

        # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        blocked_by = task.get("blocked_by", [])
        if all(b in completed_ids for b in blocked_by):
            print(f"Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°: #{task['id']}: {task['title']}")
            return

    # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ
    pending = [t for t in tasks if t["status"] == "pending"]
    in_progress = [t for t in tasks if t["status"] == "in_progress"]

    if in_progress:
        print(f"Ð’ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ: {len(in_progress)} Ð·Ð°Ð´Ð°Ñ‡(Ð¸)")
        for t in in_progress:
            print(f"  â— #{t['id']}: {t['title']}")
    elif pending:
        print("Ð’ÑÐµ pending Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÐ¼Ð¸")
    else:
        print("Ð’ÑÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹!")


def cmd_clear(project: str):
    """Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸."""
    data = load_tasks(project)

    before = len(data["tasks"])
    data["tasks"] = [t for t in data["tasks"] if t["status"] not in ("completed", "failed")]
    after = len(data["tasks"])

    save_tasks(project, data)
    print(f"Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ {before - after} Ð·Ð°Ð´Ð°Ñ‡")


def cmd_reset(project: str, task_id: int):
    """Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð² pending."""
    cmd_update_status(project, task_id, "pending")


def print_help():
    """ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ."""
    print(__doc__)


def main():
    args = sys.argv[1:]

    if not args or args[0] in ("-h", "--help", "help"):
        print_help()
        return

    cmd = args[0]

    if cmd == "list":
        project = args[1] if len(args) > 1 else None
        cmd_list(project)

    elif cmd == "add":
        if len(args) < 3:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks add PROJECT \"TITLE\" [--blocked-by X,Y]")
            sys.exit(1)

        project = args[1]
        title = args[2]
        blocked_by = []

        if "--blocked-by" in args:
            idx = args.index("--blocked-by")
            if idx + 1 < len(args):
                blocked_by = [int(x) for x in args[idx + 1].split(",")]

        cmd_add(project, title, blocked_by)

    elif cmd == "start":
        if len(args) < 3:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks start PROJECT ID")
            sys.exit(1)
        cmd_update_status(args[1], int(args[2]), "in_progress")

    elif cmd == "done":
        if len(args) < 3:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks done PROJECT ID")
            sys.exit(1)
        cmd_update_status(args[1], int(args[2]), "completed")

    elif cmd == "fail":
        if len(args) < 3:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks fail PROJECT ID")
            sys.exit(1)
        cmd_update_status(args[1], int(args[2]), "failed")

    elif cmd == "block":
        if len(args) < 3 or "--by" not in args:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks block PROJECT ID --by X,Y")
            sys.exit(1)

        project = args[1]
        task_id = int(args[2])
        idx = args.index("--by")
        blocked_by = [int(x) for x in args[idx + 1].split(",")]
        cmd_block(project, task_id, blocked_by)

    elif cmd == "next":
        if len(args) < 2:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks next PROJECT")
            sys.exit(1)
        cmd_next(args[1])

    elif cmd == "clear":
        if len(args) < 2:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks clear PROJECT")
            sys.exit(1)
        cmd_clear(args[1])

    elif cmd == "reset":
        if len(args) < 3:
            print("Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ai-tasks reset PROJECT ID")
            sys.exit(1)
        cmd_reset(args[1], int(args[2]))

    else:
        print(f"ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°: {cmd}")
        print_help()
        sys.exit(1)


if __name__ == "__main__":
    main()
