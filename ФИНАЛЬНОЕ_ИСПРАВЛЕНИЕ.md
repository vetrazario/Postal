# üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - –°–æ–∑–¥–∞–Ω–∏–µ –¢–∞–±–ª–∏—Ü—ã email_opens

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–¢–∞–±–ª–∏—Ü–∞ `email_opens` **–ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç**, –Ω–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è.

**–ü—Ä–∏—á–∏–Ω–∞**: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É–ø–∞–ª–æ –Ω–∞ –≤—Ç–æ—Ä–æ–º –∏–Ω–¥–µ–∫—Å–µ, –Ω–æ –º–∏–≥—Ä–∞—Ü–∏—è –±—ã–ª–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Å–∫—Ä–∏–ø—Ç–æ–º `fix-option-A-safe.sh`.

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ `email_clicks` - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ùå `email_opens` - –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚ùå –°–ª–µ–¥—É—é—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è `20260115000000` –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `email_opens` –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL.

---

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
cd /opt/email-sender
chmod +x fix-final-create-table.sh
./fix-final-create-table.sh
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
3. –°–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `email_opens` —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
4. –ó–∞–ø—É—Å—Ç–∏—Ç API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
5. –ü–æ–¥–æ–∂–¥—ë—Ç 30 —Å–µ–∫—É–Ω–¥
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üõ†Ô∏è –†—É—á–Ω–æ–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### –®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API

```bash
docker compose stop api
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É email_opens

```bash
docker compose exec postgres psql -U email_sender -d email_sender <<'EOF'
-- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É
CREATE TABLE IF NOT EXISTS email_opens (
  id BIGSERIAL PRIMARY KEY,
  email_log_id BIGINT NOT NULL,
  campaign_id VARCHAR(255) NOT NULL,
  ip_address VARCHAR(45),
  user_agent VARCHAR(1024),
  token VARCHAR(255) NOT NULL,
  opened_at TIMESTAMP,
  created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Foreign key
ALTER TABLE email_opens
ADD CONSTRAINT fk_rails_email_opens_email_log
FOREIGN KEY (email_log_id) REFERENCES email_logs(id);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE UNIQUE INDEX index_email_opens_on_token ON email_opens(token);
CREATE INDEX index_email_opens_on_campaign_id_and_opened_at ON email_opens(campaign_id, opened_at);
CREATE INDEX index_email_opens_on_email_log_id ON email_opens(email_log_id);

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
\d email_opens
EOF
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞

```bash
docker compose exec postgres psql -U email_sender -d email_sender -c "\d email_opens"
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–ª—è–º–∏:
- id (bigint, primary key)
- email_log_id (bigint, not null)
- campaign_id (varchar 255, not null)
- ip_address (varchar 45)
- user_agent (varchar 1024)
- token (varchar 255, not null)
- opened_at (timestamp)
- created_at (timestamp)
- updated_at (timestamp)

### –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å API

```bash
docker compose start api
sleep 30
docker compose ps
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
docker compose logs api --tail=50
```

**–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
- ‚ùå `relation "email_opens" does not exist`
- ‚ùå `PG::DuplicateTable`

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
- ‚úÖ `Puma starting in cluster mode`
- ‚úÖ `Listening on http://0.0.0.0:3000`

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª–∏

```bash
docker compose exec api rails runner "
puts 'EmailClick: ' + EmailClick.count.to_s
puts 'EmailOpen: ' + EmailOpen.count.to_s
puts '–†–∞–±–æ—Ç–∞–µ—Ç!'
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
EmailClick: 0
EmailOpen: 0
–†–∞–±–æ—Ç–∞–µ—Ç!
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –§–∏–Ω–∞–ª—å–Ω–æ–≥–æ –°–æ—Å—Ç–æ—è–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã

```bash
docker compose exec postgres psql -U email_sender -d email_sender -c "
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('email_clicks', 'email_opens')
ORDER BY table_name;
"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
```
 table_name
-------------
 email_clicks  ‚úÖ
 email_opens   ‚úÖ
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
docker compose exec postgres psql -U email_sender -d email_sender -c "
SELECT version FROM schema_migrations WHERE version LIKE '202601%' ORDER BY version;
"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å**:
```
    version
----------------
 20260114180000  (create_email_clicks)
 20260114180100  (create_email_opens)
 20260114180200  (tracking_settings)
 20260115000000  (allow_null_timestamps)  ‚Üê —ç—Ç–∞ —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è
 20260116000000  (performance_indexes)    ‚Üê –∏ —ç—Ç–∞ —Ç–æ–∂–µ
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

```bash
docker compose ps
```

**–í—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `healthy`**:
```
email_api       Up (healthy)  ‚úÖ
email_sidekiq   Up (healthy)  ‚úÖ
email_postgres  Up (healthy)  ‚úÖ
email_redis     Up (healthy)  ‚úÖ
```

### 4. –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥

```
https://linenarrow.com
```

–î–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞.

---

## üÜò –ï—Å–ª–∏ –ß—Ç–æ-—Ç–æ –ü–æ—à–ª–æ –ù–µ –¢–∞–∫

### –û—à–∏–±–∫–∞: "relation email_logs does not exist"

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü—ã `email_logs` –¥–ª—è foreign key.

**–†–µ—à–µ–Ω–∏–µ**: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ë–ï–ó foreign key constraint:

```bash
docker compose exec postgres psql -U email_sender -d email_sender <<'EOF'
-- –°–æ–∑–¥–∞—Ç—å –±–µ–∑ foreign key
CREATE TABLE IF NOT EXISTS email_opens (
  id BIGSERIAL PRIMARY KEY,
  email_log_id BIGINT NOT NULL,
  campaign_id VARCHAR(255) NOT NULL,
  ip_address VARCHAR(45),
  user_agent VARCHAR(1024),
  token VARCHAR(255) NOT NULL,
  opened_at TIMESTAMP,
  created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å—ã (–±–µ–∑ foreign key)
CREATE UNIQUE INDEX index_email_opens_on_token ON email_opens(token);
CREATE INDEX index_email_opens_on_campaign_id_and_opened_at ON email_opens(campaign_id, opened_at);
CREATE INDEX index_email_opens_on_email_log_id ON email_opens(email_log_id);
EOF
```

### –û—à–∏–±–∫–∞: "already exists"

–ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –∏–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
docker compose exec postgres psql -U email_sender -d email_sender -c "
SELECT indexname FROM pg_indexes WHERE tablename = 'email_opens';
"

# –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–æ –Ω–µ–ø–æ–ª–Ω–∞—è - —É–¥–∞–ª–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ
docker compose exec postgres psql -U email_sender -d email_sender -c "
DROP TABLE IF EXISTS email_opens CASCADE;
"

# –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –®–∞–≥–∞ 2)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –£—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

1. ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `email_opens` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏
2. ‚úÖ –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã (token, campaign_id+opened_at, email_log_id)
3. ‚úÖ API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `Up (healthy)`
4. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö `docker compose logs api`
5. ‚úÖ –ú–æ–¥–µ–ª–∏ EmailClick –∏ EmailOpen –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
6. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ `20260115000000` –∏ `20260116000000` –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
7. ‚úÖ –î–∞—à–±–æ—Ä–¥ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ

---

## üìã –ö—Ä–∞—Ç–∫–∞—è –®–ø–∞—Ä–≥–∞–ª–∫–∞

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
cd /opt/email-sender
./fix-final-create-table.sh

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
docker compose stop api
docker compose exec postgres psql -U email_sender -d email_sender <<'EOF'
CREATE TABLE IF NOT EXISTS email_opens (
  id BIGSERIAL PRIMARY KEY,
  email_log_id BIGINT NOT NULL,
  campaign_id VARCHAR(255) NOT NULL,
  ip_address VARCHAR(45),
  user_agent VARCHAR(1024),
  token VARCHAR(255) NOT NULL,
  opened_at TIMESTAMP,
  created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE UNIQUE INDEX index_email_opens_on_token ON email_opens(token);
CREATE INDEX index_email_opens_on_campaign_id_and_opened_at ON email_opens(campaign_id, opened_at);
CREATE INDEX index_email_opens_on_email_log_id ON email_opens(email_log_id);
EOF
docker compose start api
sleep 30
docker compose ps
```

---

**–ù–∞—á–Ω–∏—Ç–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞**: `./fix-final-create-table.sh`

–û–Ω –≤—Å—ë —Å–¥–µ–ª–∞–µ—Ç –∑–∞ –≤–∞—Å! üöÄ
